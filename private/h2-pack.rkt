#lang racket/base
(require "bitvector.rkt")
(provide (all-defined-out))

;; Reference:
;; - https://tools.ietf.org/html/rfc7541

;; Note on normalization: RFC 7541 says header names are treated as
;; opaque sequences of octets. But HTTP/2 .... (FIXME)

;; ----------------------------------------

;; A FlexibleHeader is one of
;; - Bytes
;; - (list FlexibleKey FlexibleValue)

;; A FlexibleKey is one of
;; - Symbol
;; - Bytes      -- normalize ???

;; A FlexibleValue is one of
;; - Bytes          -- normal header or unsplit list-valued header
;; - (Listof Bytes) -- list-valued header

#;
;; decode-headers : ?? State -> (Listof (list Symbol Bytes))
(define (decode-headers ?? state)
  __)

#;
;; encode-headers : (Listof FlexibleHeader) State -> ???
(define (encode-headers headers state)
  __)

;; ------------------------------------------------------------

;; ------------------------------------------------------------

(define static-table
  '#[;;(Index)   HeaderName                       HeaderValue
     [#;  1       #":authority"                   #f]
     [#;  2       #":method"                      #"GET"           ]
     [#;  3       #":method"                      #"POST"          ]
     [#;  4       #":path"                        #"/"             ]
     [#;  5       #":path"                        #"/index.html"   ]
     [#;  6       #":scheme"                      #"http"          ]
     [#;  7       #":scheme"                      #"https"         ]
     [#;  8       #":status"                      #"200"           ]
     [#;  9       #":status"                      #"204"           ]
     [#; 10       #":status"                      #"206"           ]
     [#; 11       #":status"                      #"304"           ]
     [#; 12       #":status"                      #"400"           ]
     [#; 13       #":status"                      #"404"           ]
     [#; 14       #":status"                      #"500"           ]
     [#; 15       #"accept-charset"               #f]
     [#; 16       #"accept-encoding"              #"gzip, deflate" ]
     [#; 17       #"accept-language"              #f]
     [#; 18       #"accept-ranges"                #f]
     [#; 19       #"accept"                       #f]
     [#; 20       #"access-control-allow-origin"  #f]
     [#; 21       #"age"                          #f]
     [#; 22       #"allow"                        #f]
     [#; 23       #"authorization"                #f]
     [#; 24       #"cache-control"                #f]
     [#; 25       #"content-disposition"          #f]
     [#; 26       #"content-encoding"             #f]
     [#; 27       #"content-language"             #f]
     [#; 28       #"content-length"               #f]
     [#; 29       #"content-location"             #f]
     [#; 30       #"content-range"                #f]
     [#; 31       #"content-type"                 #f]
     [#; 32       #"cookie"                       #f]
     [#; 33       #"date"                         #f]
     [#; 34       #"etag"                         #f]
     [#; 35       #"expect"                       #f]
     [#; 36       #"expires"                      #f]
     [#; 37       #"from"                         #f]
     [#; 38       #"host"                         #f]
     [#; 39       #"if-match"                     #f]
     [#; 40       #"if-modified-since"            #f]
     [#; 41       #"if-none-match"                #f]
     [#; 42       #"if-range"                     #f]
     [#; 43       #"if-unmodified-since"          #f]
     [#; 44       #"last-modified"                #f]
     [#; 45       #"link"                         #f]
     [#; 46       #"location"                     #f]
     [#; 47       #"max-forwards"                 #f]
     [#; 48       #"proxy-authenticate"           #f]
     [#; 49       #"proxy-authorization"          #f]
     [#; 50       #"range"                        #f]
     [#; 51       #"referer"                      #f]
     [#; 52       #"refresh"                      #f]
     [#; 53       #"retry-after"                  #f]
     [#; 54       #"server"                       #f]
     [#; 55       #"set-cookie"                   #f]
     [#; 56       #"strict-transport-security"    #f]
     [#; 57       #"transfer-encoding"            #f]
     [#; 58       #"user-agent"                   #f]
     [#; 59       #"vary"                         #f]
     [#; 60       #"via"                          #f]
     [#; 61       #"www-authenticate"             #f]])

;; Note: indexed from 1
(define (static-table-ref n)
  (unless (<= 1 n (vector-length static-table))
    (error 'static-table-ref "out of range"))
  (vector-ref static-table (sub1 n)))

(define-values (key+value-table key-table)
  (for/fold ([kvh (hash)] [kh (hash)])
            ([kv (in-vector static-table)]
             [index (in-naturals 1)])
    (if (cadr kv)
        (values (hash-set kvh kv index) kh)
        (values kvh (hash-set kh (car kv) index)))))

(define (key+value->static-index kv)
  (hash-ref key+value-table kv #f))

(define (key->static-index k)
  (hash-ref key-table k #f))

;; ------------------------------------------------------------

(define h-table-src
  '#[;;                    code as bits                   as hex     len
     ;;  sym              aligned to MSB                  aligned     in
     ;;                                                   to LSB     bits
     [#;   0  #;  _11111111_11000                             #x1ff8  13]
     [#;   1  #;  _11111111_11111111_1011000                #x7fffd8  23]
     [#;   2  #;  _11111111_11111111_11111110_0010         #xfffffe2  28]
     [#;   3  #;  _11111111_11111111_11111110_0011         #xfffffe3  28]
     [#;   4  #;  _11111111_11111111_11111110_0100         #xfffffe4  28]
     [#;   5  #;  _11111111_11111111_11111110_0101         #xfffffe5  28]
     [#;   6  #;  _11111111_11111111_11111110_0110         #xfffffe6  28]
     [#;   7  #;  _11111111_11111111_11111110_0111         #xfffffe7  28]
     [#;   8  #;  _11111111_11111111_11111110_1000         #xfffffe8  28]
     [#;   9  #;  _11111111_11111111_11101010               #xffffea  24]
     [#;  10  #;  _11111111_11111111_11111111_111100      #x3ffffffc  30]
     [#;  11  #;  _11111111_11111111_11111110_1001         #xfffffe9  28]
     [#;  12  #;  _11111111_11111111_11111110_1010         #xfffffea  28]
     [#;  13  #;  _11111111_11111111_11111111_111101      #x3ffffffd  30]
     [#;  14  #;  _11111111_11111111_11111110_1011         #xfffffeb  28]
     [#;  15  #;  _11111111_11111111_11111110_1100         #xfffffec  28]
     [#;  16  #;  _11111111_11111111_11111110_1101         #xfffffed  28]
     [#;  17  #;  _11111111_11111111_11111110_1110         #xfffffee  28]
     [#;  18  #;  _11111111_11111111_11111110_1111         #xfffffef  28]
     [#;  19  #;  _11111111_11111111_11111111_0000         #xffffff0  28]
     [#;  20  #;  _11111111_11111111_11111111_0001         #xffffff1  28]
     [#;  21  #;  _11111111_11111111_11111111_0010         #xffffff2  28]
     [#;  22  #;  _11111111_11111111_11111111_111110      #x3ffffffe  30]
     [#;  23  #;  _11111111_11111111_11111111_0011         #xffffff3  28]
     [#;  24  #;  _11111111_11111111_11111111_0100         #xffffff4  28]
     [#;  25  #;  _11111111_11111111_11111111_0101         #xffffff5  28]
     [#;  26  #;  _11111111_11111111_11111111_0110         #xffffff6  28]
     [#;  27  #;  _11111111_11111111_11111111_0111         #xffffff7  28]
     [#;  28  #;  _11111111_11111111_11111111_1000         #xffffff8  28]
     [#;  29  #;  _11111111_11111111_11111111_1001         #xffffff9  28]
     [#;  30  #;  _11111111_11111111_11111111_1010         #xffffffa  28]
     [#;  31  #;  _11111111_11111111_11111111_1011         #xffffffb  28]
     [#;  32  #;  _010100                                       #x14   6]
     [#;  33  #;  _11111110_00                                 #x3f8  10]
     [#;  34  #;  _11111110_01                                 #x3f9  10]
     [#;  35  #;  _11111111_1010                               #xffa  12]
     [#;  36  #;  _11111111_11001                             #x1ff9  13]
     [#;  37  #;  _010101                                       #x15   6]
     [#;  38  #;  _11111000                                     #xf8   8]
     [#;  39  #;  _11111111_010                                #x7fa  11]
     [#;  40  #;  _11111110_10                                 #x3fa  10]
     [#;  41  #;  _11111110_11                                 #x3fb  10]
     [#;  42  #;  _11111001                                     #xf9   8]
     [#;  43  #;  _11111111_011                                #x7fb  11]
     [#;  44  #;  _11111010                                     #xfa   8]
     [#;  45  #;  _010110                                       #x16   6]
     [#;  46  #;  _010111                                       #x17   6]
     [#;  47  #;  _011000                                       #x18   6]
     [#;  48  #;  _00000                                         #x0   5]
     [#;  49  #;  _00001                                         #x1   5]
     [#;  50  #;  _00010                                         #x2   5]
     [#;  51  #;  _011001                                       #x19   6]
     [#;  52  #;  _011010                                       #x1a   6]
     [#;  53  #;  _011011                                       #x1b   6]
     [#;  54  #;  _011100                                       #x1c   6]
     [#;  55  #;  _011101                                       #x1d   6]
     [#;  56  #;  _011110                                       #x1e   6]
     [#;  57  #;  _011111                                       #x1f   6]
     [#;  58  #;  _1011100                                      #x5c   7]
     [#;  59  #;  _11111011                                     #xfb   8]
     [#;  60  #;  _11111111_1111100                           #x7ffc  15]
     [#;  61  #;  _100000                                       #x20   6]
     [#;  62  #;  _11111111_1011                               #xffb  12]
     [#;  63  #;  _11111111_00                                 #x3fc  10]
     [#;  64  #;  _11111111_11010                             #x1ffa  13]
     [#;  65  #;  _100001                                       #x21   6]
     [#;  66  #;  _1011101                                      #x5d   7]
     [#;  67  #;  _1011110                                      #x5e   7]
     [#;  68  #;  _1011111                                      #x5f   7]
     [#;  69  #;  _1100000                                      #x60   7]
     [#;  70  #;  _1100001                                      #x61   7]
     [#;  71  #;  _1100010                                      #x62   7]
     [#;  72  #;  _1100011                                      #x63   7]
     [#;  73  #;  _1100100                                      #x64   7]
     [#;  74  #;  _1100101                                      #x65   7]
     [#;  75  #;  _1100110                                      #x66   7]
     [#;  76  #;  _1100111                                      #x67   7]
     [#;  77  #;  _1101000                                      #x68   7]
     [#;  78  #;  _1101001                                      #x69   7]
     [#;  79  #;  _1101010                                      #x6a   7]
     [#;  80  #;  _1101011                                      #x6b   7]
     [#;  81  #;  _1101100                                      #x6c   7]
     [#;  82  #;  _1101101                                      #x6d   7]
     [#;  83  #;  _1101110                                      #x6e   7]
     [#;  84  #;  _1101111                                      #x6f   7]
     [#;  85  #;  _1110000                                      #x70   7]
     [#;  86  #;  _1110001                                      #x71   7]
     [#;  87  #;  _1110010                                      #x72   7]
     [#;  88  #;  _11111100                                     #xfc   8]
     [#;  89  #;  _1110011                                      #x73   7]
     [#;  90  #;  _11111101                                     #xfd   8]
     [#;  91  #;  _11111111_11011                             #x1ffb  13]
     [#;  92  #;  _11111111_11111110_000                     #x7fff0  19]
     [#;  93  #;  _11111111_11100                             #x1ffc  13]
     [#;  94  #;  _11111111_111100                            #x3ffc  14]
     [#;  95  #;  _100010                                       #x22   6]
     [#;  96  #;  _11111111_1111101                           #x7ffd  15]
     [#;  97  #;  _00011                                         #x3   5]
     [#;  98  #;  _100011                                       #x23   6]
     [#;  99  #;  _00100                                         #x4   5]
     [#; 100  #;  _100100                                       #x24   6]
     [#; 101  #;  _00101                                         #x5   5]
     [#; 102  #;  _100101                                       #x25   6]
     [#; 103  #;  _100110                                       #x26   6]
     [#; 104  #;  _100111                                       #x27   6]
     [#; 105  #;  _00110                                         #x6   5]
     [#; 106  #;  _1110100                                      #x74   7]
     [#; 107  #;  _1110101                                      #x75   7]
     [#; 108  #;  _101000                                       #x28   6]
     [#; 109  #;  _101001                                       #x29   6]
     [#; 110  #;  _101010                                       #x2a   6]
     [#; 111  #;  _00111                                         #x7   5]
     [#; 112  #;  _101011                                       #x2b   6]
     [#; 113  #;  _1110110                                      #x76   7]
     [#; 114  #;  _101100                                       #x2c   6]
     [#; 115  #;  _01000                                         #x8   5]
     [#; 116  #;  _01001                                         #x9   5]
     [#; 117  #;  _101101                                       #x2d   6]
     [#; 118  #;  _1110111                                      #x77   7]
     [#; 119  #;  _1111000                                      #x78   7]
     [#; 120  #;  _1111001                                      #x79   7]
     [#; 121  #;  _1111010                                      #x7a   7]
     [#; 122  #;  _1111011                                      #x7b   7]
     [#; 123  #;  _11111111_1111110                           #x7ffe  15]
     [#; 124  #;  _11111111_100                                #x7fc  11]
     [#; 125  #;  _11111111_111101                            #x3ffd  14]
     [#; 126  #;  _11111111_11101                             #x1ffd  13]
     [#; 127  #;  _11111111_11111111_11111111_1100         #xffffffc  28]
     [#; 128  #;  _11111111_11111110_0110                    #xfffe6  20]
     [#; 129  #;  _11111111_11111111_010010                 #x3fffd2  22]
     [#; 130  #;  _11111111_11111110_0111                    #xfffe7  20]
     [#; 131  #;  _11111111_11111110_1000                    #xfffe8  20]
     [#; 132  #;  _11111111_11111111_010011                 #x3fffd3  22]
     [#; 133  #;  _11111111_11111111_010100                 #x3fffd4  22]
     [#; 134  #;  _11111111_11111111_010101                 #x3fffd5  22]
     [#; 135  #;  _11111111_11111111_1011001                #x7fffd9  23]
     [#; 136  #;  _11111111_11111111_010110                 #x3fffd6  22]
     [#; 137  #;  _11111111_11111111_1011010                #x7fffda  23]
     [#; 138  #;  _11111111_11111111_1011011                #x7fffdb  23]
     [#; 139  #;  _11111111_11111111_1011100                #x7fffdc  23]
     [#; 140  #;  _11111111_11111111_1011101                #x7fffdd  23]
     [#; 141  #;  _11111111_11111111_1011110                #x7fffde  23]
     [#; 142  #;  _11111111_11111111_11101011               #xffffeb  24]
     [#; 143  #;  _11111111_11111111_1011111                #x7fffdf  23]
     [#; 144  #;  _11111111_11111111_11101100               #xffffec  24]
     [#; 145  #;  _11111111_11111111_11101101               #xffffed  24]
     [#; 146  #;  _11111111_11111111_010111                 #x3fffd7  22]
     [#; 147  #;  _11111111_11111111_1100000                #x7fffe0  23]
     [#; 148  #;  _11111111_11111111_11101110               #xffffee  24]
     [#; 149  #;  _11111111_11111111_1100001                #x7fffe1  23]
     [#; 150  #;  _11111111_11111111_1100010                #x7fffe2  23]
     [#; 151  #;  _11111111_11111111_1100011                #x7fffe3  23]
     [#; 152  #;  _11111111_11111111_1100100                #x7fffe4  23]
     [#; 153  #;  _11111111_11111110_11100                  #x1fffdc  21]
     [#; 154  #;  _11111111_11111111_011000                 #x3fffd8  22]
     [#; 155  #;  _11111111_11111111_1100101                #x7fffe5  23]
     [#; 156  #;  _11111111_11111111_011001                 #x3fffd9  22]
     [#; 157  #;  _11111111_11111111_1100110                #x7fffe6  23]
     [#; 158  #;  _11111111_11111111_1100111                #x7fffe7  23]
     [#; 159  #;  _11111111_11111111_11101111               #xffffef  24]
     [#; 160  #;  _11111111_11111111_011010                 #x3fffda  22]
     [#; 161  #;  _11111111_11111110_11101                  #x1fffdd  21]
     [#; 162  #;  _11111111_11111110_1001                    #xfffe9  20]
     [#; 163  #;  _11111111_11111111_011011                 #x3fffdb  22]
     [#; 164  #;  _11111111_11111111_011100                 #x3fffdc  22]
     [#; 165  #;  _11111111_11111111_1101000                #x7fffe8  23]
     [#; 166  #;  _11111111_11111111_1101001                #x7fffe9  23]
     [#; 167  #;  _11111111_11111110_11110                  #x1fffde  21]
     [#; 168  #;  _11111111_11111111_1101010                #x7fffea  23]
     [#; 169  #;  _11111111_11111111_011101                 #x3fffdd  22]
     [#; 170  #;  _11111111_11111111_011110                 #x3fffde  22]
     [#; 171  #;  _11111111_11111111_11110000               #xfffff0  24]
     [#; 172  #;  _11111111_11111110_11111                  #x1fffdf  21]
     [#; 173  #;  _11111111_11111111_011111                 #x3fffdf  22]
     [#; 174  #;  _11111111_11111111_1101011                #x7fffeb  23]
     [#; 175  #;  _11111111_11111111_1101100                #x7fffec  23]
     [#; 176  #;  _11111111_11111111_00000                  #x1fffe0  21]
     [#; 177  #;  _11111111_11111111_00001                  #x1fffe1  21]
     [#; 178  #;  _11111111_11111111_100000                 #x3fffe0  22]
     [#; 179  #;  _11111111_11111111_00010                  #x1fffe2  21]
     [#; 180  #;  _11111111_11111111_1101101                #x7fffed  23]
     [#; 181  #;  _11111111_11111111_100001                 #x3fffe1  22]
     [#; 182  #;  _11111111_11111111_1101110                #x7fffee  23]
     [#; 183  #;  _11111111_11111111_1101111                #x7fffef  23]
     [#; 184  #;  _11111111_11111110_1010                    #xfffea  20]
     [#; 185  #;  _11111111_11111111_100010                 #x3fffe2  22]
     [#; 186  #;  _11111111_11111111_100011                 #x3fffe3  22]
     [#; 187  #;  _11111111_11111111_100100                 #x3fffe4  22]
     [#; 188  #;  _11111111_11111111_1110000                #x7ffff0  23]
     [#; 189  #;  _11111111_11111111_100101                 #x3fffe5  22]
     [#; 190  #;  _11111111_11111111_100110                 #x3fffe6  22]
     [#; 191  #;  _11111111_11111111_1110001                #x7ffff1  23]
     [#; 192  #;  _11111111_11111111_11111000_00           #x3ffffe0  26]
     [#; 193  #;  _11111111_11111111_11111000_01           #x3ffffe1  26]
     [#; 194  #;  _11111111_11111110_1011                    #xfffeb  20]
     [#; 195  #;  _11111111_11111110_001                     #x7fff1  19]
     [#; 196  #;  _11111111_11111111_100111                 #x3fffe7  22]
     [#; 197  #;  _11111111_11111111_1110010                #x7ffff2  23]
     [#; 198  #;  _11111111_11111111_101000                 #x3fffe8  22]
     [#; 199  #;  _11111111_11111111_11110110_0            #x1ffffec  25]
     [#; 200  #;  _11111111_11111111_11111000_10           #x3ffffe2  26]
     [#; 201  #;  _11111111_11111111_11111000_11           #x3ffffe3  26]
     [#; 202  #;  _11111111_11111111_11111001_00           #x3ffffe4  26]
     [#; 203  #;  _11111111_11111111_11111011_110          #x7ffffde  27]
     [#; 204  #;  _11111111_11111111_11111011_111          #x7ffffdf  27]
     [#; 205  #;  _11111111_11111111_11111001_01           #x3ffffe5  26]
     [#; 206  #;  _11111111_11111111_11110001               #xfffff1  24]
     [#; 207  #;  _11111111_11111111_11110110_1            #x1ffffed  25]
     [#; 208  #;  _11111111_11111110_010                     #x7fff2  19]
     [#; 209  #;  _11111111_11111111_00011                  #x1fffe3  21]
     [#; 210  #;  _11111111_11111111_11111001_10           #x3ffffe6  26]
     [#; 211  #;  _11111111_11111111_11111100_000          #x7ffffe0  27]
     [#; 212  #;  _11111111_11111111_11111100_001          #x7ffffe1  27]
     [#; 213  #;  _11111111_11111111_11111001_11           #x3ffffe7  26]
     [#; 214  #;  _11111111_11111111_11111100_010          #x7ffffe2  27]
     [#; 215  #;  _11111111_11111111_11110010               #xfffff2  24]
     [#; 216  #;  _11111111_11111111_00100                  #x1fffe4  21]
     [#; 217  #;  _11111111_11111111_00101                  #x1fffe5  21]
     [#; 218  #;  _11111111_11111111_11111010_00           #x3ffffe8  26]
     [#; 219  #;  _11111111_11111111_11111010_01           #x3ffffe9  26]
     [#; 220  #;  _11111111_11111111_11111111_1101         #xffffffd  28]
     [#; 221  #;  _11111111_11111111_11111100_011          #x7ffffe3  27]
     [#; 222  #;  _11111111_11111111_11111100_100          #x7ffffe4  27]
     [#; 223  #;  _11111111_11111111_11111100_101          #x7ffffe5  27]
     [#; 224  #;  _11111111_11111110_1100                    #xfffec  20]
     [#; 225  #;  _11111111_11111111_11110011               #xfffff3  24]
     [#; 226  #;  _11111111_11111110_1101                    #xfffed  20]
     [#; 227  #;  _11111111_11111111_00110                  #x1fffe6  21]
     [#; 228  #;  _11111111_11111111_101001                 #x3fffe9  22]
     [#; 229  #;  _11111111_11111111_00111                  #x1fffe7  21]
     [#; 230  #;  _11111111_11111111_01000                  #x1fffe8  21]
     [#; 231  #;  _11111111_11111111_1110011                #x7ffff3  23]
     [#; 232  #;  _11111111_11111111_101010                 #x3fffea  22]
     [#; 233  #;  _11111111_11111111_101011                 #x3fffeb  22]
     [#; 234  #;  _11111111_11111111_11110111_0            #x1ffffee  25]
     [#; 235  #;  _11111111_11111111_11110111_1            #x1ffffef  25]
     [#; 236  #;  _11111111_11111111_11110100               #xfffff4  24]
     [#; 237  #;  _11111111_11111111_11110101               #xfffff5  24]
     [#; 238  #;  _11111111_11111111_11111010_10           #x3ffffea  26]
     [#; 239  #;  _11111111_11111111_1110100                #x7ffff4  23]
     [#; 240  #;  _11111111_11111111_11111010_11           #x3ffffeb  26]
     [#; 241  #;  _11111111_11111111_11111100_110          #x7ffffe6  27]
     [#; 242  #;  _11111111_11111111_11111011_00           #x3ffffec  26]
     [#; 243  #;  _11111111_11111111_11111011_01           #x3ffffed  26]
     [#; 244  #;  _11111111_11111111_11111100_111          #x7ffffe7  27]
     [#; 245  #;  _11111111_11111111_11111101_000          #x7ffffe8  27]
     [#; 246  #;  _11111111_11111111_11111101_001          #x7ffffe9  27]
     [#; 247  #;  _11111111_11111111_11111101_010          #x7ffffea  27]
     [#; 248  #;  _11111111_11111111_11111101_011          #x7ffffeb  27]
     [#; 249  #;  _11111111_11111111_11111111_1110         #xffffffe  28]
     [#; 250  #;  _11111111_11111111_11111101_100          #x7ffffec  27]
     [#; 251  #;  _11111111_11111111_11111101_101          #x7ffffed  27]
     [#; 252  #;  _11111111_11111111_11111101_110          #x7ffffee  27]
     [#; 253  #;  _11111111_11111111_11111101_111          #x7ffffef  27]
     [#; 254  #;  _11111111_11111111_11111110_000          #x7fffff0  27]
     [#; 255  #;  _11111111_11111111_11111011_10           #x3ffffee  26]
     [#; 256  #;  _11111111_11111111_11111111_111111      #x3fffffff  30]])

(define h-table
  (for/vector ([e (in-vector h-table-src)])
    (make-be-sbv (car e) (cadr e))))

;; A HuffmanTree is one of
;; - Nat
;; - (cons HuffmanTree HuffmanTree) -- (cons 0-branch 1-branch)

(define h-decode-tree
  (let ()
    (define init-codes
      (for/list ([code (in-vector h-table)] [value (in-naturals)])
        (cons code value)))
    (define (take-entries codes bit)
      (for/list ([e (in-list codes)] #:when (= (sbv-car (car e)) bit))
        (cons (sbv-cdr (car e)) (cdr e))))
    (let loop ([codes init-codes])
      (cond [(= (length codes) 1)
             (cdr (car codes))]
            [else
             (cons (loop (take-entries codes 0))
                   (loop (take-entries codes 1)))]))))

(define (h-encode-byte b)
  (vector-ref h-table b))

(define (h-encode bs)
  (define bbuf (make-bitbuffer))
  (for ([b (in-bytes bs)])
    (bitbuffer-write-sbv bbuf (h-encode-byte b)))
  (bitbuffer-get-bytes bbuf))

(define (h-decode bs start-biti end-biti)
  (define out (open-output-bytes))
  (define (decode-byte biti)
    (let loop ([biti biti] [tree h-decode-tree])
      (cond [(pair? tree)
             (unless (< biti end-biti)
               (error 'h-decode "incomplete stream"))
             (if (bytes-be-bit-set? bs biti)
                 (loop (add1 biti) (cdr tree))
                 (loop (add1 biti) (car tree)))]
            [(byte? tree)
             (write-byte tree out)
             (decode-rest biti)]
            [(= tree 256) ;; EOS
             (done biti #t)])))
  (define (decode-rest biti)
    (cond [(< biti end-biti)
           (decode-byte biti)]
          [else (done biti #f)]))
  (define (done biti eos?)
    (values (get-output-bytes out) biti eos?))
  (decode-rest start-biti))
